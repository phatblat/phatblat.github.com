<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[phatblat's reflog]]></title>
  <link href="http://phatblat.com/atom.xml" rel="self"/>
  <link href="http://phatblat.com/"/>
  <updated>2015-02-04T23:00:39-07:00</updated>
  <id>http://phatblat.com/</id>
  <author>
    <name><![CDATA[Ben Chatelain]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Communicating Between an iOS App and a Watch Extension]]></title>
    <link href="http://phatblat.com/blog/2015/02/04/communicating-between-an-ios-app-and-a-watch-extension/"/>
    <updated>2015-02-04T22:13:24-07:00</updated>
    <id>http://phatblat.com/blog/2015/02/04/communicating-between-an-ios-app-and-a-watch-extension</id>
    <content type="html"><![CDATA[<p>I&rsquo;m building a WatchKit extension for an existing iOS app and have been experimenting with the &ldquo;plumbing&rdquo; between the two. Watch extensions are different animals than other iOS 8 extensions, but there is a lot of overlap in this area. Today I made a diagram to show the options of getting data to the iPhone app from the Watch and vice-versa.</p>

<p><img src="http://phatblat.com/images/apple_watch_communication.png" title="Communicating between an iOS App and a Watch Extension" alt="a flowchart diagram"></p>

<p>This is simply a graphical representation of the summary presented in a <a href="https://devforums.apple.com/thread/256667?tstart=0">Developer Forums thread</a>.</p>

<p>The real gem in this is that Darwin notifications (<code>CFNotificationCenterGetDarwinNotifyCenter</code>) can be used to notify the other processes that there is new data available in the shared container. I haven&rsquo;t worked with Darwin notifications before, but the big difference from NSNotifications is that you can&rsquo;t pass any data along with it, just an identifier.</p>

<p>Note that &ldquo;write data to shared container&rdquo; includes any API that writes out files &ndash; just point it inside the NSURL returned <code>-[NSFileManager containerURLForSecurityApplicationGroupIdentifier:]</code>.</p>

<h2>NSUserDefaults</h2>

<p>If you&rsquo;re using NSUserDefaults, it&rsquo;s just an API on top of a plist file. When you stand up an NSUserDefaults instance using <code>-initWithSuiteName:</code> the data ends up in a file <code>&lt;SHARED_CONTAINER&gt;/Library/Preferences/&lt;APP_ID&gt;.plist</code> (where SHARED_CONTAINER is something like <code>~/Library/Developer/CoreSimulator/Devices/1A8DF360-B0A6-4815-95F3-68A6AB0BCC78/data/Container/Data/Application/</code>). That file will be written to every time you call <code>+synchronize</code> or at &ldquo;periodic intervals&rdquo;.</p>

<h2>Other Tidbits</h2>

<p><a href="https://github.com/mutualmobile/MMWormhole">MMWormhole</a> is a very neat library which handles a lot of these details for you providing a simple API for passing messages between an iOS app and extensions.</p>

<p>Tom Harrington has some great (extension development tips)[<a href="http://atomicbird.com/blog/ios-app-extension-tips">http://atomicbird.com/blog/ios-app-extension-tips</a>].</p>

<p>Remember to <a href="https://developer.apple.com/library/ios/technotes/tn2408/_index.html">stay away from the file coordination APIs</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Git Sparse Checkout]]></title>
    <link href="http://phatblat.com/blog/2014/09/14/git-sparse-checkout/"/>
    <updated>2014-09-14T17:30:57-06:00</updated>
    <id>http://phatblat.com/blog/2014/09/14/git-sparse-checkout</id>
    <content type="html"><![CDATA[<p>Have you ever wanted to download just a subfolder of a git repo? Sure, you can clone the whole repo and then drill into that subfolder. However, if the point of just bringing down a subfolder is for easier distribution of just some of the files, the other files in the repo can be distracting (i.e. &ldquo;which sub-sub-sub folder did she say to open?&rdquo;).</p>

<!-- more -->


<p>Git is a system designed to remember every change to the tracked files in a repository. Once a file goes in, it&rsquo;s there for good since it becomes part of the log history (unless you slice and dice it with filter-branch, but that has side-effects). Since remembering your files and their content is a primary feature, git doesn&rsquo;t currently have the ability to clone just a subfolder (which would save bandwidth). However, git does have the ability to checkout a subset of the repo, like a subfolder. This is what&rsquo;s referred to as a &ldquo;sparse checkout&rdquo;.</p>

<p>The exercise here is to get a copy of just the images from my blog. Not terribly exciting, but I&rsquo;ve devised a script which should be easy for you to adapt for this same purpose for any other repo.</p>

<h2>The Code</h2>

<script src="https://gist.github.com/phatblat/a5caa3bb3a3784f03000.js"></script>


<p>I&rsquo;m going to walk through this script with the lines a bit out of order; variables will be interspersed with the code that uses them. I generally build scripts with all the variables at the top to make it easy to see what can be tweaked, but having them inline makes the logic easier to follow.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>tmpdir=/tmp/phatblat-images
</span><span class='line'>mkdir $tmpdir
</span><span class='line'>cd $tmpdir
</span><span class='line'>git init</span></code></pre></td></tr></table></div></figure>


<p>This sets up a fresh, empty repository in a temporary directory.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>remote_git=git://github.com/phatblat/phatblat.github.io.git
</span><span class='line'>git remote add -f origin $remote_git</span></code></pre></td></tr></table></div></figure>


<p>The <strong>-f</strong> flag to the <code>git remote add</code> command causes git to immediately fetch from the remote when it is added. This is where this approach is less than idea. All objects in the repo are fetched from the remote, even though only a subset of the files will be checked out. However, this keeps the repo functional as I&rsquo;ll talk about at the end.</p>

<h2>Git Protocol</h2>

<p>The reason for the <code>git://</code> protocol is because this is the <a href="http://git-scm.com/book/en/Git-on-the-Server-The-Protocols#The-Git-Protocol">fastest transfer protocol available</a>. This is the best approach for fast, read-only access to a repo, but could fail from inside a corporate firewall.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>remote_https=https://github.com/phatblat/phatblat.github.io.git
</span><span class='line'>git remote add -f origin $remote_git || \
</span><span class='line'>  git remote set-url origin $remote_https && \
</span><span class='line'>  git fetch origin</span></code></pre></td></tr></table></div></figure>


<p>If the fetch fails due to the <code>git://</code> protocol being blocked (port 9418), the indented commands will execute and change the origin remote&rsquo;s url to one that uses https and try fetching again. There is a significant delay before the fetch fails. I haven&rsquo;t figured out how to shorten the timeout that git uses.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git config core.sparseCheckout true
</span><span class='line'>subdir=images/
</span><span class='line'>echo "$subdir" &gt; .git/info/sparse-checkout</span></code></pre></td></tr></table></div></figure>


<p>The new repo is configured to with sparse checkout enabled for only the &ldquo;images&rdquo; folder. No other folders will be checked out.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git checkout master</span></code></pre></td></tr></table></div></figure>


<p>The checkout is where the filtering happens. Here the <code>master</code> branch is being checked out, but only the images folder is actually being copied into the work tree.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>subdir=images/
</span><span class='line'>open $subdir</span></code></pre></td></tr></table></div></figure>


<p>This <a href="https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man1/open.1.html">open</a> command on OS X is very handy for opening a folder in the Finder.</p>

<h2>Use Cases</h2>

<h3>Designer-Managed Images</h3>

<p>Beyond effectively downloading a subfolder, this sparse checkout has other uses. The resulting local repo is a fully functional git repo. You can browse the history and create new commits. This makes it especially handy for designers to manage images without fear of accidentally changing any other files. By checking out only the images folder, finding the existing images is also easier due to less noise from files and folders unrelated to the designers tasks.</p>

<h3>Octopress Zen Mode</h3>

<p>The <code>sparse-checkout</code> file uses the same syntax as <code>.gitignore</code>. The following lines tell git to only checkout markdown files:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>*.md
</span><span class='line'>*.markdown</span></code></pre></td></tr></table></div></figure>


<p>After changing the <code>.git/info/sparse-checkout</code> file, do a <code>checkout &lt;branch&gt;</code> (<code>checkout source</code> in the case of Octopress) in order to update the work tree with this new &ldquo;view&rdquo; of files.</p>

<p><img class="center" src="http://phatblat.com/images/git-sparse-checkout-markdown.png" title="Sparse checkout of only markdown files" alt="an image from OS X Terminal showing a tree of only markdown files"></p>

<p>After getting this far into this feature of git, I may end up using it to help reduce the filesystem noise from Octopress. It always takes me a few minutes to remember where everything goes.</p>

<h2>Caveats</h2>

<p>Note that if you plan to use a repo with sparse checkout for creating new commits and pushing these back to a central remote, you&rsquo;ll need to ditch the <code>git://</code> protocol since it can only be used for read-only access. Either HTTPS or <a href="https://help.github.com/articles/which-remote-url-should-i-use#cloning-with-ssh">SSH</a> style URLs can be used for pushing changes up. Also, if you&rsquo;ve already cloned a repo using the <code>git://</code> protocol, you don&rsquo;t need to re-clone it to change this protocol. Just use the <a href="https://help.github.com/articles/changing-a-remote-s-url"><code>git remote set-url</code></a> command to change the remote URL.</p>

<p>For more details around what you can do with it, check out the docs on <a href="http://git-scm.com/docs/git-read-tree#_sparse_checkout">sparse checkout</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Configuring a KST Particle: iBeacon from 360|iDev]]></title>
    <link href="http://phatblat.com/blog/2014/08/29/configuring-a-kst-particle-ibeacon-from-360%7Cidev/"/>
    <updated>2014-08-29T21:43:46-06:00</updated>
    <id>http://phatblat.com/blog/2014/08/29/configuring-a-kst-particle-ibeacon-from-360|idev</id>
    <content type="html"><![CDATA[<p><img class="right" src="http://phatblat.com/images/particle_back.jpg" width="150" title="Particle iBeacon" alt="an image of a Particle device showing a number on the back"></p>

<p>Everyone who attended this year&rsquo;s <a href="http://360idev.com">360|iDev</a> in Denver was given a <a href="https://kstechnologies.com/particle/">Particle</a> from KS Technologies. These are simple looking iBeacon devices that are fully configurable via KST&rsquo;s <a href="https://itunes.apple.com/us/app/particle-accelerator/id727105504?mt=8">Particle Accelerator</a> app. KST also posted about this <a href="https://kstechnologies.com/free-360idev-ibeacon/">awesome giveaway</a> on their blog.</p>

<h3>tl;dr</h3>

<blockquote><p>The password scheme for the Particles given out at 360|iDev is: <strong>360iDev123</strong> — where <em>123</em> is the number on the back.</p></blockquote>

<!-- more -->


<h1>Battery Drain</h1>

<p>First off, whenever you&rsquo;re not using your Particle, I suggest pulling the battery out or inserting something to prevent the flow of current. There&rsquo;s no &ldquo;off&rdquo; switch and the device will continually broadcast its iBeacon signal dilligently every 100 milliseconds (default rate) until the battery runs out of juice (40 days, according to the <a href="https://itunes.apple.com/us/app/particle-calculator/id909745776?mt=8">Particle Calculator</a> app). The CR2032 coin cell batteries are cheap and easy to find, but you might as well save yourself the trouble and prevent the battery from draining when you&rsquo;re not using the device.</p>

<h2>Battery Removal</h2>

<p>Taking out the battery is easy. The case is best opened with a Chuck E. Cheese token, but in a pinch a quarter, lightning connector, flat-head screwdriver or even a keyring works too. Just insert in the slot on the top and twist until the shell pops. The plastic shell is easily scratched, but that only affects your opinion of the device &ndash; not the performance.</p>

<p>After you pop the top off, use a pen to push the coin battery down toward the less-round end.</p>

<p>When you put the battery back in, the positive (+) side goes up.</p>

<p><img src="http://phatblat.com/images/particle_opening_slot.png" width="200" title="Particle shell opening slot" alt="an image of opening the Particle using a coin">
<img src="http://phatblat.com/images/particle_battery.jpg" width="200" title="Particle battery removal" alt="an image of the Particle battery being removed">
<img src="http://phatblat.com/images/particle_open.jpg" width="200" title="Particle open with battery out" alt="an image of the Particle internals"></p>

<h1>Config Prep</h1>

<p>Before continuing, you&rsquo;ll need the following:</p>

<ul>
<li>iOS device with 7.0+ and BLE

<ul>
<li>YES: iPhone 4s/5/5s/5c, iPad &frac34;/mini/Air, iPod &ldquo;tall&rdquo; (touch 5th gen)</li>
<li>NO: iPhone 4, iPad 2, iPod touch 4th gen</li>
</ul>
</li>
<li>the <a href="https://itunes.apple.com/us/app/particle-accelerator/id727105504?mt=8">Particle Accelerator</a> app</li>
<li>Bluetooth enabled</li>
</ul>


<h1>Configuration</h1>

<p><img class="right" src="http://phatblat.com/images/particle_accelerator_app.png" width="200" title="Particle Accelerator app" alt="an image of the Particle Accelerator app showing my device"></p>

<p>Launch the Particle Accelerator app and tap the toggle switch in the upper right corner to enable scanning. Once your Particle appears, tap on it to bring up the configuration screen.</p>

<h2>Password</h2>

<p>The password scheme for the Particles given out at 360|iDev is: <strong>360iDev123</strong> — where <em>123</em> is the number on the back.</p>

<p>The number on the back of my Particle is 57, so the initial password to configure it was 360iDev57 (no leading zeros).</p>

<p>You can change the password once the current password is accepted. A blank password is allowed and does make it easier to use the app since you will be asked for the password each time you connect to the Particle. However, if you set a blank password, remember to either set a real password when you&rsquo;re done or remove the battery. Anyone else with the Particle Accelerator app could muck with your new Particle if you forget.</p>

<h2>UUID</h2>

<blockquote><p>NOTE: As of version 2.1.1, the Set UUID screen <em>always</em> sets the UUID when you tap the &ldquo;Done&rdquo; button; there is no way to cancel, besides killing the app. So, only tap on the UUID on the configuration screen if you intend to change it.</p></blockquote>

<p>The UUID essentially defines a group of iBeacons. In the CoreLocation API, each <code>CLBeaconRegion</code> is identified by the UUID, and there can be many iBeacons in each region. It is also possible to monitor for multiple beacon regions at the same time.</p>

<p>The Particles given out at 360|iDev all have their UUID set to <strong>7D65B622-4AA8-4560-914C-502BE940BC16</strong>. You can change this if you want. One of the UUIDs used by the AirLocate app (see below) is already in the list (E2C56DB5-DFFB-48D2-B060-D0F5A71096E0), so you can simply select this if you&rsquo;re wanting to test.</p>

<p>You can also give your Particle a unique UUID. On your mac, the <code>uuidgen</code> terminal command will generate a new UUID.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ uuidgen                                                                                            
</span><span class='line'>30FDAAFB-C585-4DA5-81F9-2CA293EFCF93</span></code></pre></td></tr></table></div></figure>


<h2>Major &amp; Minor Numbers</h2>

<p>Within a single <code>CLBeaconRegion</code>, individual <code>CLBeacon</code> instances are identified by unique combinations of the <code>major</code> and <code>minor</code> numbers. The Particles from 360|iDev all have a <code>major</code> value of 1 and unique <code>minor</code> numbers that correspond to the number printed on the back of the shell.</p>

<h1>Testing your Particle</h1>

<p><img class="right" src="http://phatblat.com/images/particle_detector_app.png" width="170" title="Particle Detector app" alt="an image of the Particle Detector app showing my device"></p>

<h2>Particle Detector</h2>

<p><a href="https://itunes.apple.com/us/app/particle-detector/id724226138?mt=8">https://itunes.apple.com/us/app/particle-detector/id724226138?mt=8</a></p>

<p>This free app from KST shows you details about any Particles that are nearby. It can only monitor one region UUID at a time, so it&rsquo;s easiest if you copy the UUID string from your browser and paste it into the filter screen. Then, make sure to select the UUID.</p>

<h2>AirLocate</h2>

<p><a href="https://developer.apple.com/LIBRARY/ios/samplecode/AirLocate/Introduction/Intro.html">https://developer.apple.com/LIBRARY/ios/samplecode/AirLocate/Introduction/Intro.html</a></p>

<p>This sample app was released at WWDC 2013 for testing iBeacons.</p>

<p><img class="right" src="http://phatblat.com/images/roygbeacon.png" width="170" title="RoyGBeacon app" alt="an image of Roy G. Beacon app with a red background showing my device"></p>

<h2>RoyGBeacon</h2>

<p><a href="https://github.com/phatblat/RoyGBeacon">https://github.com/phatblat/RoyGBeacon</a></p>

<p>I created a simple app which changes the background color of the screen from gray to red depending on how close you are to an iBeacon. This app will work with any brand of iBeacon, but you may need to <a href="https://github.com/phatblat/RoyGBeacon/blob/master/RoyGBeacon/RGBMainViewController.m#L41">modify the source</a> to add the UUID of your beacon (the AirLocate and 360|iDev UUIDs are included).</p>

<h2>BTLExplorer</h2>

<p><a href="https://itunes.apple.com/us/app/btlexplorer/id532751145?mt=8">https://itunes.apple.com/us/app/btlexplorer/id532751145?mt=8</a></p>

<p>Another app from KST. This one is a general discovery app for any Bluetooth device. Useful for monitoring signal strength and determining whether there is a problem at the hardware level (usually battery).</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Speed up pod install]]></title>
    <link href="http://phatblat.com/blog/2014/07/30/pod-install/"/>
    <updated>2014-07-30T22:30:54-06:00</updated>
    <id>http://phatblat.com/blog/2014/07/30/pod-install</id>
    <content type="html"><![CDATA[<p>If you use CocoaPods, you&rsquo;re familiar with the <code>pod install</code> command. Especially in the process of creating a pod, you end up running this command a lot. The annoying part is that there&rsquo;s a delay before it starts returning much output. This is where the pod gem reaches out to check to see if the specs have changed at all.</p>

<p>Even when the pod version specifiers haven&rsquo;t changed, CocoaPods reaches out to fetch any updates to the <code>master</code> spec repo, along with any private spec repos that may be configured. During local development of a pod, this slows down the process unnecessarily as the only changes you care about are local to your hard drive.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ pod install --verbose
</span><span class='line'>
</span><span class='line'>Analyzing dependencies
</span><span class='line'>
</span><span class='line'>Updating spec repositories
</span><span class='line'>  $ /usr/local/bin/git rev-parse  &gt;/dev/null 2&gt;&1
</span><span class='line'>  $ /usr/local/bin/git ls-remote
</span><span class='line'>  From https://github.com/CocoaPods/Specs.git
</span><span class='line'>  f83cbf438a0f80b7df76534ffa08efcb359ce982    HEAD
</span><span class='line'>  f83cbf438a0f80b7df76534ffa08efcb359ce982    refs/heads/master
</span><span class='line'>  fe7df26fe5545072c11abac241d73087a29e87d9    refs/pull/1/head
</span><span class='line'>  1748dab37fe08120775777a084e0fb9da10c4a63    refs/pull/1/merge
</span><span class='line'>  ...
</span><span class='line'>  5a7c7be28f0859865035c324e625c507cf858f4a  refs/pull/9998/head
</span><span class='line'>  7a19ff8bfbaf00a485ca2274a229205d715dcbf7  refs/pull/9999/head
</span><span class='line'>Updating spec repo `master`
</span><span class='line'>  $ /usr/local/bin/git pull --ff-only
</span><span class='line'>  ...yawn...</span></code></pre></td></tr></table></div></figure>




<!-- more -->


<h2>&mdash;no-repo-update</h2>

<p>The <strong>&mdash;no-repo-update</strong> switch suppresses this spec repo update and speeds up the install command considerably.</p>

<p>Since that is way too much to type for such a common command to fly across my terminal, I like to wrap these up in a nice, short <a href="https://github.com/phatblat/dotfiles/blob/master/.dotfiles/shell/alias.zsh#L31">alias</a>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>alias pi='pod install --no-repo-update'</span></code></pre></td></tr></table></div></figure>


<p>Another situation where suppressing this automatic spec repo update is helpful is when you have unreliable or no network connection. The spec repo update is going to fail anyway.</p>

<p>Now, you don&rsquo;t want to use this alias every time you need to do a <code>pod install</code> as your <code>master</code> spec repo would get out of date and you could miss important updates. In general, I allow <code>pod install</code> or <code>pod update</code> to update my spec repos the first time I run them on any given day and suppress the repo update the rest of the day.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Delta Service for Mobile Apps]]></title>
    <link href="http://phatblat.com/blog/2014/02/20/delta-service/"/>
    <updated>2014-02-20T20:59:10-07:00</updated>
    <id>http://phatblat.com/blog/2014/02/20/delta-service</id>
    <content type="html"><![CDATA[<p>A typical RESTful API is simple and intuitive to consume, but requires a lot of service calls in order to download a large dataset. This can be a problem in mobile when an app simply doesn’t have the time or the bandwidth to wait for all the service calls to finish collecting the dataset.</p>

<!-- more -->


<p>There are a few options to try to improve on this:</p>

<ol>
<li> Create a search service to return just the data that the client needs at the time</li>
<li> Download the entire dataset with a single service call</li>
<li> Pre-install the data on the client (mobile apps only)</li>
</ol>


<h3>Option #1 &ndash; Search</h3>

<p>The search option is the only option for extremely large datasets; you simply can’t download all the data from Google Maps onto a mobile device. With search, there is the risk that repeated searches will download some of the same content, wasting bandwidth. Also, every search needs a network connection and takes time to complete, introducing delays to the user experience. In some cases, such as identical search terms, caching can improve upon these issues.</p>

<h3>Option #2 &ndash; One-shot</h3>

<p>Downloading the entire dataset in a single service call can be significantly faster than the many requests necessary to do so using a RESTful API. A typical RESTful API requires one request to get a list of resources and then n requests to fetch all the resources individually (n+1 requests). The gain with downloading the entire set at once is the removal of the request overhead (and startup delay) for n requests. Additionally, compressing larger response payloads has a bigger benefit than compressing small ones. However, this “download everything” option has the greatest impact on UX as the client has to download and process the entire payload before the user can benefit from the data.</p>

<h3>Option #3 &ndash; Pre-install</h3>

<p>Pre-installing the data on the client has the biggest UX benefit: immediate availablility of the data. Note that this benefit is only realized after the mobile app has been downloaded and installed from the app store. The initial download takes longer since the app bundle is larger due to the included data. A big issue with packaging the data in the app is that you have to release an update to the app in order to get updated data into the hands of your users. This is a big delay as development, testing and Apple’s review all have to complete before the update is available. The upside to this delay is that during the entire release process users have a copy of the data and can continue using it, but it’s growing stale. Additionally, users have to actually install the update. There are always some users that don’t update their apps. Depending on how critical the data is, this can be a showstopper for some apps.
Both RESTful and search APIs have the downside of requiring a network connection in order to get any data. Previously requested data can be served up from a cache, but that doesn’t help if the user is asking for data that hasn’t been cached. While the “download everything” and pre-installed data options require network connections to get the data into the app, once that is complete the network is no longer required. Thus, these latter options provide the best offline experience.</p>

<p>So, it would seem that we have to choose between the following experiences:</p>

<ul>
<li> Delayed, on-demand data</li>
<li> Can’t do anything for a while, but then it’s fast</li>
<li> Slow app install, everything’s snappy, stale data</li>
</ul>


<p>I propose a mix of all three in order to provide the ultimate experience.</p>

<h2>Solution</h2>

<p>At a high level, here’s the idea: pre-install a snapshot of the dataset in the app at build time (Option #3). At some point after app launch, the app calls a “delta&#8221; API asking for all changes to the dataset since a given point in time (Option #1, search by time). The service responds with either an empty response, or with a payload which includes only the resources that have changed. Where the entire dataset download comes into play (Option #2) is that if there are ever issues with applying the delta, the client has an option to reset its data to a pristine state. Hopefully, this never happens, but if it does it’s better to temporarily degrade the UX rather than let the app continue using stale data forever.</p>

<p>Before I get any further into the details, I want to call out the pros and cons of this delta API approach.</p>

<h3>Pros</h3>

<ul>
<li> Data is immediately available after app install</li>
<li> Data is available offline</li>
<li> Data is updated every time the app is used (provided server is reachable)</li>
<li> Server outage or maintenance has little to no impact on client</li>
<li> Updates are smaller so less potential for user confusion due to looking at data which changes after the update</li>
<li> Searching is fast</li>
</ul>


<h3>Cons</h3>

<ul>
<li> Longer app download times due to larger app binary</li>
<li> Not for large datasets (~50MB+)</li>
<li> Other than offline, benefits will not be that different from a simple RESTful or search API for small datasets (&lt;100KB)</li>
<li> Complex implementation, requiring coordination between server and client</li>
<li> Server needs to track and record dates for data changes over time</li>
<li> Extra build step to update the pre-installed data</li>
</ul>


<h2>Design</h2>

<p>Let’s start with the “download everything” call. This is just a service endpoint that a GET request invokes a response which contains the entire dataset in question.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>GET /api/widgets
</span><span class='line'>Accept: */*
</span><span class='line'>
</span><span class='line'>HTTP/1.1 200 OK
</span><span class='line'>Date: Tue, 04 Feb 2014 16:30:30 GMT
</span><span class='line'>Last-Modified: Tue, 04 Feb 2014 16:30:30 GMT
</span><span class='line'>Content-Type: application/json
</span><span class='line'>
</span><span class='line'>{
</span><span class='line'>    "widgets": [
</span><span class='line'>        {
</span><span class='line'>            "name": "Widget 1",
</span><span class='line'>            "color": "blue"
</span><span class='line'>        }, {
</span><span class='line'>            "name": "Widget 2",
</span><span class='line'>            "color": "yellow"
</span><span class='line'>        }, {
</span><span class='line'>            "name": "Widget 3",
</span><span class='line'>            "color": "red"
</span><span class='line'>        }, {
</span><span class='line'>            "name": "Widget 4",
</span><span class='line'>            "color": "green"
</span><span class='line'>        }, {
</span><span class='line'>            "name": "Widget 5",
</span><span class='line'>            "color": "gray"
</span><span class='line'>        }, {
</span><span class='line'>            "name": "Widget 6",
</span><span class='line'>            "color": "white"
</span><span class='line'>        }
</span><span class='line'>    ]
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>This service call will be used by the client whenever there is a problem applying a delta update. It also provides an interface for the build prep process to grab a current copy of the data to be included in the app bundle.</p>

<p>In order to stay as close to the principles of REST, the delta functionality comes into play when the client does a conditional GET and includes an If-Modified-Since header in the request.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>GET /api/widgets
</span><span class='line'>Accept: */*
</span><span class='line'>If-Modified-Since: Wed, 05 Feb 2014 19:08:16 GMT
</span><span class='line'>
</span><span class='line'>HTTP/1.1 200 OK
</span><span class='line'>Date: Thu, 06 Feb 2014 13:31:30 GMT
</span><span class='line'>Last-Modified: Thu, 06 Feb 2014 13:31:30 GMT
</span><span class='line'>Content-Type: application/json
</span><span class='line'>
</span><span class='line'>{
</span><span class='line'>    "widgets": [
</span><span class='line'>        {
</span><span class='line'>            "name": "Widget 2",
</span><span class='line'>            "color": "yellow"
</span><span class='line'>        }, {
</span><span class='line'>            "name": "Widget 6",
</span><span class='line'>            "color": "white"
</span><span class='line'>        }
</span><span class='line'>    ]
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>The records included in the response body are upserted into the client’s data; any that don’t exist are created, those that do are updated if any of the attributes have changed.</p>

<p>This takes care of creating and updating records, but what about removing records? The simplest approach I’ve been able to come up with is to include a “hidden” attribute with a value of true which instructs the client to stop displaying that record. This approach allows for bringing back records in the future.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>GET /api/widgets
</span><span class='line'>Accept: */*
</span><span class='line'>If-Modified-Since: Thu, 06 Feb 2014 13:31:30 GMT
</span><span class='line'>
</span><span class='line'>HTTP/1.1 200 OK
</span><span class='line'>Date: Fri, 07 Feb 2014 20:04:06 GMT
</span><span class='line'>Last-Modified: Fri, 07 Feb 2014 20:04:06 GMT
</span><span class='line'>Content-Type: application/json
</span><span class='line'>
</span><span class='line'>{
</span><span class='line'>    "widgets": [
</span><span class='line'>        {
</span><span class='line'>            "name": "Widget 1",
</span><span class='line'>            "color": "blue",
</span><span class='line'>            "hidden": true
</span><span class='line'>        }
</span><span class='line'>    ]
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>The last example is when a client asks for changes, but nothing has changed. In this case the response will have a 304 status code and an empty body. This tells the client it is up-to-date.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>GET /api/widgets
</span><span class='line'>Accept: */*
</span><span class='line'>If-Modified-Since: Fri, 07 Feb 2014 20:04:06 GMT
</span><span class='line'>
</span><span class='line'>HTTP/1.1 304 Not Modified
</span><span class='line'>Date: Sat, 08 Feb 2014 12:01:06 GMT
</span><span class='line'>Last-Modified: Sat, 08 Feb 2014 12:01:06 GMT</span></code></pre></td></tr></table></div></figure>


<h2>Date Handling</h2>

<p>With the myriad of problems that can arise with interpreting dates, it is very important for the client to treat the value of the Last-Modified response header as an opaque string and return the exact same value in the If-Modified-Since request header of the next request to the service.</p>

<p>On the server side it’s also important to pay attention to the exact time that the “last modified” attribute gets set on the records. If there is any delay between when this value is set and that record is available to clients through the delta service, any clients calling in during this gap will miss changes. Say you decide to update records in a staging database and the &ldquo;last modified” timestamp gets set there (Sat, 08 Feb 2014 17:00:00 GMT), meanwhile a client hits the service and receives a response with some changes (Last-Modified header Sat, 08 Feb 2014 17:15:00 GMT) then after the changes have been validated in the staging area they are moved out to the production database (Sat, 08 Feb 2014 18:00:00 GMT). At this point the “last modified” attributes on the recently changed records are an hour old. The client that last called in at 17:15 will ask for changes since 17:15 the next time, but those changes that were applied with a 17:00 timestamp will be skipped for that client. This leads to very strange stale data issues that are difficult to debug.</p>

<p>An alternative to using dates is to use an integer version number. This strays from REST and requires the server to keep track of these numeric versions. But, the server implementation could be as simple as a mapping of version numbers to dates which are then used to query against the “last modified” attribute of the records. Note that the point of version numbers would not be to support returning old version of the data. This is far more work as it requires storing snapshots of every version of every record, at least those versions that have changed. The point of this delta service is to quickly and efficiently update clients to the latest version of the data.</p>
]]></content>
  </entry>
  
</feed>
